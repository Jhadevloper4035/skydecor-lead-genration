<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Lead Management Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="icon" type="image/png" href="/favicon/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/favicon/favicon.svg" />
  <link rel="shortcut icon" href="/favicon/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-title" content="Skydecor Lead" />
  <link rel="manifest" href="/favicon/site.webmanifest" />

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="/css/admindashboard.css">



</head>

<body>

  <!-- Sidebar Overlay for Mobile -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- Sidebar -->

  <%- include('../partials/side-menu') %>



    <!-- Main Content -->
    <main class="main-content">
      <!-- Top Header -->
      <header class="top-header">
        <div class="header-left">
          <button class="menu-toggle" id="menuToggle">
            <i class="bi bi-list"></i>
          </button>
          <div class="search-box">
            <i class="bi bi-search"></i>
            <input type="text" placeholder="Search...">
          </div>
        </div>

        <div class="header-right">
          <button class="header-icon-btn">
            <i class="bi bi-flag"></i>
          </button>
          <button class="header-icon-btn">
            <i class="bi bi-grid-3x3"></i>
          </button>
          <button class="header-icon-btn">
            <i class="bi bi-bell"></i>
            <span class="badge">3</span>
          </button>
          <button class="header-icon-btn">
            <i class="bi bi-arrows-fullscreen"></i>
          </button>
          <button class="header-icon-btn">
            <i class="bi bi-moon"></i>
          </button>
          <button class="header-icon-btn">
            <i class="bi bi-bell"></i>
            <span class="badge">3</span>
          </button>

          <div class="user-profile">
            <img src="https://ui-avatars.com/api/?name=<%= user.name %>&background=5b4a9f&color=fff" alt="User"
              class="user-avatar">
            <div class="user-info">
              <h6 style="text-transform: capitalize;">
                <%= user.name %>
              </h6>
              <p style="text-transform: uppercase;">
                <%= user.accessType %>
              </p>
            </div>
          </div>
        </div>
      </header>

      <!-- Page Content -->
      <div class="page-content">
        <!-- Page Header -->
        <div class="page-header">
          <div>
            <h1 class="page-title">
              <%= place %>
            </h1>
            <div class="breadcrumb-custom">
              <a href="#">Dashboards</a>
              <i class="bi bi-chevron-right"></i>
              <span style="text-transform: uppercase;">
                <%= user.accessType %>
              </span>
              <i class="bi bi-chevron-right"></i>
              <span>
                <%= place %>
              </span>
            </div>
          </div>
        </div>

        <!-- Hero Card -->
        <div class="hero-card">
          <div class="hero-content">
            <div class="hero-text">
              <h2>Discover, Collect, Track and Manage <span class="highlight">your Leads.</span></h2>
              <p>The world's first and largest lead management platform.</p>
              <div class="hero-buttons">
                <a  href="/admin/download/<%= place %>"   class="btn-hero primary" style="text-decoration: none;"> <i class="bi bi-download"></i> All Leads</a>
                <a href="/form/event" style="text-decoration: none;" class="btn-hero secondary">Add New Lead</a>
              </div>
            </div>
            <div class="hero-illustration">
              <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                <circle cx="100" cy="100" r="80" fill="#fbbf24" opacity="0.2" />
                <circle cx="100" cy="80" r="30" fill="#764ba2" />
                <rect x="75" y="110" width="50" height="60" rx="5" fill="#667eea" />
                <circle cx="85" cy="90" r="5" fill="white" />
                <circle cx="115" cy="90" r="5" fill="white" />
              </svg>
            </div>
          </div>
        </div>

        <!-- Stats Cards -->
        <div class="stats-row">


          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon green">
                <i class="bi bi-calendar-event"></i>
              </div>
              <button class="stat-menu">
                <i class="bi bi-three-dots-vertical"></i>
              </button>
            </div>
            <div class="stat-label">All lead <%= place %>
            </div>
            <div class="stat-value">
              <%= leads.length %>
            </div>
            <div class="stat-change up">
              <i class="bi bi-arrow-up"></i>
              <span>Active leads</span>
            </div>
          </div>




          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon green">
                <i class="bi bi-calendar-event"></i>
              </div>
              <button class="stat-menu">
                <i class="bi bi-three-dots-vertical"></i>
              </button>
            </div>
            <div class="stat-label">All Dealar</div>
            <div class="stat-value">
              <%= leads.filter(l=> l.UserType === 'Dealer').length %>
            </div>
          </div>







          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon green">
                <i class="bi bi-calendar-event"></i>
              </div>
              <button class="stat-menu">
                <i class="bi bi-three-dots-vertical"></i>
              </button>
            </div>
            <div class="stat-label">All End Customer</div>
            <div class="stat-value">
              <%= leads.filter(l=> l.UserType === 'End Customer').length %>
            </div>
          </div>





        </div>



        <!-- Leads Table -->
        <div class="leads-table-wrapper">
          <div class="table-header">
            <div class="table-filters">

             

              <select class="filter-select" id="userTypeFilter">
                <option value="all">All User Types</option>
                <option value="architect">Architect</option>
                <option value="dealer">Dealer</option>
                <option value="customer">Customer</option>
              </select>

              <select class="filter-select" id="statusFilter">
                <option value="all">All Status</option>
                <option value="new">New</option>
                <option value="contacted">Contacted</option>
                <option value="qualified">Qualified</option>
              </select>
            </div>

            <div class="table-actions">
              <a href="/admin/download/<%= place %>" class="btn-action primary">
                <i class="bi bi-download"></i> Export
              </a>
            </div>
          </div>

          <div class="table-container">
            <table class="leads-table">
              <thead>
                <tr>
                  <th>Contact</th>
                  <th>Mobile</th>
                  <th>User Type</th>
                  <th>Products</th>
                  <th>Company</th>
                  <th>Location</th>
                  <th>Representative</th>
                  <th>Lead Type</th>
                  <th>Place</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="leadsTableBody">
                <% if (leads && leads.length> 0) { %>
                  <% leads.forEach(lead=> { %>
                    <tr data-lead-type="<%= (lead.leadType || '').toLowerCase() %>"
                      data-user-type="<%= (lead.UserType || '').toLowerCase() %>">
                      <td>
                        <div class="lead-user">
                          <div class="lead-avatar">
                            <%= (lead.fullName || 'U' ).charAt(0).toUpperCase() %>
                          </div>
                          <div>
                            <div class="lead-name">
                              <%= lead.fullName || 'N/A' %>
                            </div>
                            <div class="lead-email">
                              <%= lead.email || 'No email' %>
                            </div>
                          </div>
                        </div>
                      </td>
                      <td><strong>
                          <%= lead.countryCode || '' %>
                            <%= lead.mobileNumber || 'N/A' %>
                        </strong></td>
                      <td>
                        <% let userTypeClass='badge-customer' ; const userType=(lead.UserType || '' ).toLowerCase(); if
                          (userType==='architect' ) userTypeClass='badge-architect' ; else if (userType==='dealer' )
                          userTypeClass='badge-dealer' ; %>
                          <span class="badge-type <%= userTypeClass %>">
                            <%= lead.UserType || 'N/A' %>
                          </span>
                      </td>
                      <td>
                        <div class="product-list">
                          <% if (Array.isArray(lead.ProductEnquire) && lead.ProductEnquire.length> 0) { %>
                            <% lead.ProductEnquire.forEach(p=> { %>
                              <span class="product-badge">
                                <%= p %>
                              </span>
                              <% }) %>
                                <% } else if (lead.ProductEnquire) { %>
                                  <span class="product-badge">
                                    <%= lead.ProductEnquire %>
                                  </span>
                                  <% } else { %>
                                    <span class="product-badge">None</span>
                                    <% } %>
                        </div>
                      </td>
                      <td>
                        <%= lead.companyName || 'N/A' %>
                      </td>
                      <td>
                        <strong>
                          <%= lead.city || 'N/A' %>
                        </strong><br>
                        <small style="color: var(--text-muted);">
                          <%= lead.state || '' %>
                        </small>
                      </td>
                      <td>
                        <%= lead.representative || 'N/A' %>
                      </td>
                      <td>
                        <span
                          class="badge-type <%= (lead.leadType || '').toLowerCase() === 'event' ? 'badge-event' : 'badge-showroom' %>">
                          <%= lead.leadType || 'N/A' %>
                        </span>
                      </td>
                      <td>
                        <%= lead.place || 'N/A' %>
                      </td>
                      <td>
                        <strong>
                          <%= new Date(lead.createdAt).toLocaleDateString() %>
                        </strong><br>
                        <small style="color: var(--text-muted);">
                          <%= new Date(lead.createdAt).toLocaleTimeString([], {hour: '2-digit' , minute:'2-digit'}) %>
                        </small>
                      </td>
                      <td>
                        <div class="action-buttons">
                          <button class="action-icon-btn call" title="Call"
                            onclick="window.location.href='tel:<%= lead.countryCode %><%= lead.mobileNumber %>'">
                            <i class="bi bi-telephone"></i>
                          </button>
                          <button class="action-icon-btn email" title="Email"
                            onclick="window.location.href='mailto:<%= lead.email %>'">
                            <i class="bi bi-envelope"></i>
                          </button>
                          <button class="action-icon-btn more" title="More">
                            <i class="bi bi-three-dots"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                    <% }) %>
                      <% } %>
              </tbody>
            </table>
          </div>

          <div class="table-footer">
            <div class="showing-info">
              Showing <strong id="showingCount">0</strong> of <strong id="totalCount">0</strong> leads
            </div>
            <div class="pagination">
              <button class="page-btn"><i class="bi bi-chevron-left"></i></button>
              <button class="page-btn active">1</button>
              <button class="page-btn">2</button>
              <button class="page-btn">3</button>
              <button class="page-btn"><i class="bi bi-chevron-right"></i></button>
            </div>
          </div>
        </div>

      </div>
    </main>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Mobile Menu Toggle
      const menuToggle = document.getElementById('menuToggle');
      const sidebar = document.getElementById('sidebar');
      const sidebarOverlay = document.getElementById('sidebarOverlay');

      menuToggle.addEventListener('click', function () {
        sidebar.classList.toggle('active');
        sidebarOverlay.classList.toggle('active');
      });

      sidebarOverlay.addEventListener('click', function () {
        sidebar.classList.remove('active');
        sidebarOverlay.classList.remove('active');
      });

      // Get all filter elements
      const headerSearchInput = document.querySelector('.search-box input');
      const leadTypeFilter = document.getElementById('leadTypeFilter');
      const userTypeFilter = document.getElementById('userTypeFilter');
      const statusFilter = document.getElementById('statusFilter');

      // Update Counts - now counts only visible rows
      function updateCounts() {
        const allRows = document.querySelectorAll('#leadsTableBody tr');
        const visibleRows = Array.from(allRows).filter(row => row.style.display !== 'none');

        let eventCount = 0;
        let showroomCount = 0;
        let totalCount = 0;

        // Count from visible rows only
        visibleRows.forEach(row => {
          const leadType = row.getAttribute('data-lead-type');
          if (leadType === 'event') eventCount++;
          if (leadType === 'showroom') showroomCount++;
          totalCount++;
        });

        // Update all count displays
        document.getElementById('eventLeads').textContent = eventCount;
        document.getElementById('showroomLeads').textContent = showroomCount;
        document.getElementById('totalLeads').textContent = totalCount;
        document.getElementById('totalCount').textContent = allRows.length;
        document.getElementById('activeLeads').textContent = totalCount;
        document.getElementById('convertedLeads').textContent = Math.floor(totalCount * 0.3);
        document.getElementById('showingCount').textContent = visibleRows.length;
      }

      // Main filter function that combines all filters
      function filterTable() {
        const searchTerm = headerSearchInput.value.toLowerCase().trim();
        const leadTypeValue = leadTypeFilter.value;
        const userTypeValue = userTypeFilter.value;
        const statusValue = statusFilter.value;

        const rows = document.querySelectorAll('#leadsTableBody tr');

        rows.forEach(row => {
          // Get row data
          const leadType = row.getAttribute('data-lead-type');
          const userType = row.getAttribute('data-user-type');
          const rowText = row.textContent.toLowerCase();

          // Check each filter condition
          const matchesSearch = searchTerm === '' || rowText.includes(searchTerm);
          const matchesLeadType = leadTypeValue === 'all' || leadType === leadTypeValue;
          const matchesUserType = userTypeValue === 'all' || userType === userTypeValue;
          // Status filter could be implemented based on your data structure
          const matchesStatus = statusValue === 'all'; // Add your status logic here

          // Show row only if ALL conditions match
          if (matchesSearch && matchesLeadType && matchesUserType && matchesStatus) {
            row.style.display = '';
          } else {
            row.style.display = 'none';
          }
        });

        // Update counts after filtering
        updateCounts();
      }

      // Add event listeners to all filters
      if (headerSearchInput) {
        headerSearchInput.addEventListener('input', filterTable);
        headerSearchInput.addEventListener('keyup', filterTable);
      }

      leadTypeFilter.addEventListener('change', filterTable);
      userTypeFilter.addEventListener('change', filterTable);
      statusFilter.addEventListener('change', filterTable);

      // Clear all filters function
      function clearAllFilters() {
        if (headerSearchInput) {
          headerSearchInput.value = '';
        }
        leadTypeFilter.value = 'all';
        userTypeFilter.value = 'all';
        statusFilter.value = 'all';
        filterTable();
      }

      // Add clear filter button functionality
      const filterButtons = document.querySelectorAll('.btn-action');
      filterButtons.forEach(btn => {
        if (btn.textContent.includes('Filter')) {
          btn.addEventListener('click', function () {
            // Toggle filter visibility or open filter modal
            alert('Filter panel - you can add advanced filter UI here');
          });
        }
      });

      // Time filter buttons functionality
      const timeButtons = document.querySelectorAll('.time-btn');
      timeButtons.forEach(btn => {
        btn.addEventListener('click', function () {
          // Remove active class from all buttons
          timeButtons.forEach(b => b.classList.remove('active'));
          // Add active class to clicked button
          this.classList.add('active');

          // Get the time period
          const period = this.textContent.trim();

          // Filter leads based on time period
          filterByTimePeriod(period);
        });
      });

      // Filter by time period
      function filterByTimePeriod(period) {
        const rows = document.querySelectorAll('#leadsTableBody tr');
        const now = new Date();
        let startDate;

        switch (period) {
          case '1M':
            startDate = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
            break;
          case '6M':
            startDate = new Date(now.getFullYear(), now.getMonth() - 6, now.getDate());
            break;
          case '1Y':
            startDate = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
            break;
          case 'ALL':
          default:
            // Show all rows
            rows.forEach(row => {
              row.removeAttribute('data-time-filtered');
            });
            filterTable();
            return;
        }

        rows.forEach(row => {
          // Get the date cell (10th column - index 9)
          const dateCell = row.cells[9];
          if (dateCell) {
            const dateText = dateCell.querySelector('strong').textContent;
            const rowDate = new Date(dateText);

            if (rowDate >= startDate) {
              row.removeAttribute('data-time-filtered');
            } else {
              row.setAttribute('data-time-filtered', 'true');
            }
          }
        });

        filterTable();
      }

      // Enhanced filter function to include time filtering
      function filterTable() {
        const searchTerm = headerSearchInput ? headerSearchInput.value.toLowerCase().trim() : '';
        const leadTypeValue = leadTypeFilter.value;
        const userTypeValue = userTypeFilter.value;
        const statusValue = statusFilter.value;

        const rows = document.querySelectorAll('#leadsTableBody tr');

        rows.forEach(row => {
          // Get row data
          const leadType = row.getAttribute('data-lead-type');
          const userType = row.getAttribute('data-user-type');
          const rowText = row.textContent.toLowerCase();
          const timeFiltered = row.hasAttribute('data-time-filtered');

          // Check each filter condition
          const matchesSearch = searchTerm === '' || rowText.includes(searchTerm);
          const matchesLeadType = leadTypeValue === 'all' || leadType === leadTypeValue;
          const matchesUserType = userTypeValue === 'all' || userType === userTypeValue;
          const matchesStatus = statusValue === 'all';
          const matchesTime = !timeFiltered;

          // Show row only if ALL conditions match
          if (matchesSearch && matchesLeadType && matchesUserType && matchesStatus && matchesTime) {
            row.style.display = '';
          } else {
            row.style.display = 'none';
          }
        });

        // Update counts after filtering
        updateCounts();
      }

      // Pagination functionality
      const pageButtons = document.querySelectorAll('.page-btn');
      pageButtons.forEach(btn => {
        btn.addEventListener('click', function () {
          if (this.querySelector('i')) return; // Skip arrow buttons for now

          // Remove active class from all
          pageButtons.forEach(b => b.classList.remove('active'));
          // Add active to clicked
          this.classList.add('active');
        });
      });

      // Export functionality
      const exportBtn = document.querySelector('.btn-action.primary');
      if (exportBtn) {
        exportBtn.addEventListener('click', function () {
          // Get visible rows only
          const visibleRows = Array.from(document.querySelectorAll('#leadsTableBody tr'))
            .filter(row => row.style.display !== 'none');

          if (visibleRows.length === 0) {
            alert('No leads to export!');
            return;
          }

          // Create CSV content
          let csv = 'Name,Email,Mobile,User Type,Products,Company,Location,Representative,Lead Type,Place,Date\n';

          visibleRows.forEach(row => {
            const cells = row.cells;
            const name = cells[0].querySelector('.lead-name').textContent;
            const email = cells[0].querySelector('.lead-email').textContent;
            const mobile = cells[1].textContent.trim();
            const userType = cells[2].textContent.trim();
            const products = cells[3].textContent.trim();
            const company = cells[4].textContent.trim();
            const location = cells[5].textContent.trim().replace(/\n/g, ' ');
            const representative = cells[6].textContent.trim();
            const leadType = cells[7].textContent.trim();
            const place = cells[8].textContent.trim();
            const date = cells[9].textContent.trim().replace(/\n/g, ' ');

            csv += `"${name}","${email}","${mobile}","${userType}","${products}","${company}","${location}","${representative}","${leadType}","${place}","${date}"\n`;
          });

          // Download CSV
          const blob = new Blob([csv], { type: 'text/csv' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `leads_export_${new Date().toISOString().split('T')[0]}.csv`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        });
      }

      // Add keyboard shortcuts
      document.addEventListener('keydown', function (e) {
        // Ctrl/Cmd + K to focus search
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
          e.preventDefault();
          if (headerSearchInput) {
            headerSearchInput.focus();
          }
        }

        // Escape to clear search
        if (e.key === 'Escape' && headerSearchInput) {
          if (headerSearchInput === document.activeElement) {
            headerSearchInput.value = '';
            filterTable();
            headerSearchInput.blur();
          }
        }
      });

      // Initialize on page load
      document.addEventListener('DOMContentLoaded', function () {
        updateCounts();

        // Add placeholder enhancement
        if (headerSearchInput) {
          headerSearchInput.placeholder = 'Search leads... (Ctrl+K)';
        }
      });

      // Real-time search feedback
      if (headerSearchInput) {
        headerSearchInput.addEventListener('input', function () {
          const searchWrapper = this.parentElement;
          if (this.value.trim() !== '') {
            searchWrapper.style.borderColor = 'var(--primary-purple)';
          } else {
            searchWrapper.style.borderColor = '';
          }
        });
      }
    </script>

</body>

</html>