<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Lead Management Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="icon" type="image/png" href="/favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon/favicon.svg" />
    <link rel="shortcut icon" href="/favicon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Skydecor Lead" />
    <link rel="manifest" href="/favicon/site.webmanifest" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/css/admindashboard.css">
</head>

<body>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <%- include('../partials/side-menu') %>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Top Header -->
        <header class="top-header">
            <div class="header-left">
                <button class="menu-toggle" id="menuToggle">
                    <i class="bi bi-list"></i>
                </button>
                <div class="search-box">
                    <i class="bi bi-search"></i>
                    <input type="text" placeholder="Search...">
                </div>
            </div>

            <div class="header-right">
                <button class="header-icon-btn">
                    <i class="bi bi-flag"></i>
                </button>
                <button class="header-icon-btn">
                    <i class="bi bi-grid-3x3"></i>
                </button>
                <button class="header-icon-btn">
                    <i class="bi bi-bell"></i>
                    <span class="badge">3</span>
                </button>
                <button class="header-icon-btn">
                    <i class="bi bi-arrows-fullscreen"></i>
                </button>
                <button class="header-icon-btn">
                    <i class="bi bi-moon"></i>
                </button>

                <div class="user-profile">
                    <img src="https://ui-avatars.com/api/?name=<%= user.name %>&background=5b4a9f&color=fff"
                        class="user-avatar">
                    <div class="user-info">
                        <h6 style="text-transform: capitalize;">
                            <%= user.name %>
                        </h6>
                        <p style="text-transform: uppercase;">
                            <%= user.accessType %>
                        </p>
                    </div>
                </div>
            </div>
        </header>

        <!-- Page Content -->
        <div class="page-content">
            <!-- Page Header -->
            <div class="page-header mt-4">
                <div>
                    <h1 class="page-title">Product Enquiry</h1>
                    <div class="breadcrumb-custom">
                        <a href="#" style="text-transform: uppercase;">Dashboards</a>
                        <i class="bi bi-chevron-right"></i>
                        <span style="text-transform: uppercase;">Website</span>
                        <i class="bi bi-chevron-right"></i>
                        <span style="text-transform: uppercase;">product Enquiry</span>
                    </div>
                </div>
            </div>

            <!-- Hero Card -->
            <div class="hero-card">
                <div class="hero-content">
                    <div class="hero-text">
                        <h2>Discover, Collect, Track and Manage <span class="highlight">your Leads.</span></h2>
                        <p>The world's first and largest lead management platform.</p>
                        <div class="hero-buttons">
                            <a href="/admin/website/product/enquiry/download" class="btn-hero primary"
                                style="text-decoration: none;"> <i class="bi bi-download"></i> All Leads
                            </a>
                            <a href="/form/inquiry" style="text-decoration: none;" class="btn-hero secondary">Add
                                New Lead</a>
                        </div>
                    </div>
                    <div class="hero-illustration">
                        <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="100" cy="100" r="80" fill="#fbbf24" opacity="0.2" />
                            <circle cx="100" cy="80" r="30" fill="#764ba2" />
                            <rect x="75" y="110" width="50" height="60" rx="5" fill="#667eea" />
                            <circle cx="85" cy="90" r="5" fill="white" />
                            <circle cx="115" cy="90" r="5" fill="white" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon green">
                            <i class="bi bi-people"></i>
                        </div>
                        <button class="stat-menu">
                            <i class="bi bi-three-dots-vertical"></i>
                        </button>
                    </div>
                    <div class="stat-label">Total Leads</div>
                    <div class="stat-value" id="totalLeads">
                        <%= leads.length %>
                    </div>
                    <div class="stat-change up">
                        <i class="bi bi-arrow-up"></i>
                        <span>Active leads</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon blue">
                            <i class="bi bi-hourglass-split"></i>
                        </div>
                        <button class="stat-menu">
                            <i class="bi bi-three-dots-vertical"></i>
                        </button>
                    </div>
                    <div class="stat-label">Pending Leads</div>
                    <div class="stat-value" id="pendingLeads">
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon orange">
                            <i class="bi bi-globe"></i>
                        </div>
                        <button class="stat-menu">
                            <i class="bi bi-three-dots-vertical"></i>
                        </button>
                    </div>
                    <div class="stat-label">Website Source</div>
                    <div class="stat-value" id="websiteLeads">
                    </div>
                </div>
            </div>

            <!-- Leads Table -->
            <div class="leads-table-wrapper">
                <div class="table-header">
                    <div class="table-filters">
                        <select class="filter-select" id="statusFilter">
                            <option value="all">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="contacted">Contacted</option>
                            <option value="converted">Converted</option>
                        </select>

                        <select class="filter-select" id="sourceFilter">
                            <option value="all">All Sources</option>
                            <option value="website">Website</option>
                            <option value="phone">Phone</option>
                            <option value="email">Email</option>
                        </select>
                    </div>

                    <div class="table-actions">
                        <a href="/admin/website/product/enquiry/download" class="btn-action primary">
                            <i class="bi bi-download"></i> Export All
                        </a>
                    </div>
                </div>

                <div class="table-container">
                    <table class="leads-table">
                        <thead>
                            <tr>
                                <th>Contact</th>
                                <th>Phone</th>
                                <th>Product Interest</th>
                                <th>Quantity</th>
                                <th>Message</th>
                                <th>Status</th>
                                <th>Source</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="leadsTableBody">
                            <% if (leads && leads.length > 0) { %>
                                <% leads.forEach(lead => { %>
                                    <tr data-status="<%= (lead.status || '').toLowerCase() %>"
                                        data-source="<%= (lead.source || '').toLowerCase() %>">
                                        <td>
                                            <div class="lead-user">
                                                <div class="lead-avatar">
                                                    <%= (lead.fullName || 'U').charAt(0).toUpperCase() %>
                                                </div>
                                                <div>
                                                    <div class="lead-name">
                                                        <%= lead.fullName || 'N/A' %>
                                                    </div>
                                                    <div class="lead-email">
                                                        <%= lead.email || 'No email' %>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td><strong>
                                                <%= lead.phone || 'N/A' %>
                                            </strong></td>
                                        <td>
                                            <div class="product-list">
                                                <span class="product-badge">
                                                    <%= lead.productInterest || 'N/A' %>
                                                </span>
                                            </div>
                                        </td>
                                        <td>
                                            <%= lead.estimatedQuantity || 'Not specified' %>
                                        </td>
                                        <td>
                                            <div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                                                title="<%= lead.message || '' %>">
                                                <%= lead.message || 'No message' %>
                                            </div>
                                        </td>
                                        <td>
                                            <% 
                                            let statusClass = 'badge-customer';
                                            const status = (lead.status || '').toLowerCase();
                                            if (status === 'pending') {
                                                statusClass = 'badge-pending';
                                            } else if (status === 'contacted') {
                                                statusClass = 'badge-contacted';
                                            } else if (status === 'converted') {
                                                statusClass = 'badge-converted';
                                            }
                                            %>
                                            <span class="badge-type <%= statusClass %>">
                                                <%= lead.status || 'N/A' %>
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge-type badge-dealer">
                                                <%= lead.source || 'N/A' %>
                                            </span>
                                        </td>
                                        <td>
                                            <strong>
                                                <%= new Date(lead.createdAt).toLocaleDateString() %>
                                            </strong><br>
                                            <small style="color: var(--text-muted);">
                                                <%= new Date(lead.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) %>
                                            </small><br>
                                            <small style="color: var(--primary-purple);">
                                                <%= lead.timeElapsed || '' %>
                                            </small>
                                        </td>
                                        <td>
                                            <div class="action-buttons">
                                                <button class="action-icon-btn call" title="Call"
                                                    onclick="window.location.href='tel:<%= lead.phone %>'">
                                                    <i class="bi bi-telephone"></i>
                                                </button>
                                                <button class="action-icon-btn email" title="Email"
                                                    onclick="window.location.href='mailto:<%= lead.email %>'">
                                                    <i class="bi bi-envelope"></i>
                                                </button>
                                                <button class="action-icon-btn view" title="View Details"
                                                    onclick="viewLeadDetails('<%= lead._id %>')">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                                <button class="action-icon-btn more" title="More">
                                                    <i class="bi bi-three-dots"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                <% }) %>
                            <% } %>
                        </tbody>
                    </table>
                </div>

                <div class="table-footer">
                    <div class="showing-info">
                        Showing <strong id="showingCount">0</strong> of <strong id="totalCount">0</strong> leads
                    </div>

                    <% 
                    const totalItems = leads.length;
                    const perPage = 10;
                    const page = 1;
                    const totalPages = Math.ceil(totalItems / perPage);
                    %>

                    <div class="pagination">
                        <!-- Prev Button -->
                        <button class="page-btn <%= page === 1 ? 'disabled' : '' %>">
                            <i class="bi bi-chevron-left"></i>
                        </button>

                      <!-- Page Numbers -->
<% for(let i = 1; i <= totalPages; i++) { %>
    <a 
        class="page-btn <%= page === i ? 'active' : '' %>"
        href="<%= API_ENDPOINT %>/api/lead/productEnquiry?page=<%= i %>&limit=10"
    >
        <%= i %>
    </a>
<% } %>


                        <!-- Next Button -->
                        <button class="page-btn <%= page === totalPages ? 'disabled' : '' %>">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Mobile Menu Toggle
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        menuToggle.addEventListener('click', function () {
            sidebar.classList.toggle('active');
            sidebarOverlay.classList.toggle('active');
        });

        sidebarOverlay.addEventListener('click', function () {
            sidebar.classList.remove('active');
            sidebarOverlay.classList.remove('active');
        });

        // Get all filter elements
        const headerSearchInput = document.querySelector('.search-box input');
        const statusFilter = document.getElementById('statusFilter');
        const sourceFilter = document.getElementById('sourceFilter');

        // Update Counts - now counts only visible rows
        function updateCounts() {
            const allRows = document.querySelectorAll('#leadsTableBody tr');
            const visibleRows = Array.from(allRows).filter(row => row.style.display !== 'none');

            let pendingCount = 0;
            let contactedCount = 0;
            let convertedCount = 0;
            let websiteCount = 0;

            // Count from visible rows only
            visibleRows.forEach(row => {
                const status = row.getAttribute('data-status');
                const source = row.getAttribute('data-source');

                if (status === 'pending') pendingCount++;
                if (status === 'contacted') contactedCount++;
                if (status === 'converted') convertedCount++;
                if (source === 'website') websiteCount++;
            });

            // Update all count displays
            document.getElementById('totalLeads').textContent = visibleRows.length;
            document.getElementById('pendingLeads').textContent = pendingCount;
            document.getElementById('websiteLeads').textContent = websiteCount;
            document.getElementById('totalCount').textContent = allRows.length;
            document.getElementById('showingCount').textContent = visibleRows.length;
        }

        // Main filter function that combines all filters
        function filterTable() {
            const searchTerm = headerSearchInput.value.toLowerCase().trim();
            const statusValue = statusFilter.value;
            const sourceValue = sourceFilter.value;

            const rows = document.querySelectorAll('#leadsTableBody tr');

            rows.forEach(row => {
                // Get row data
                const status = row.getAttribute('data-status');
                const source = row.getAttribute('data-source');
                const rowText = row.textContent.toLowerCase();

                // Check each filter condition
                const matchesSearch = searchTerm === '' || rowText.includes(searchTerm);
                const matchesStatus = statusValue === 'all' || status === statusValue;
                const matchesSource = sourceValue === 'all' || source === sourceValue;

                // Show row only if ALL conditions match
                if (matchesSearch && matchesStatus && matchesSource) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });

            // Update counts after filtering
            updateCounts();
        }

        // Add event listeners to all filters
        if (headerSearchInput) {
            headerSearchInput.addEventListener('input', filterTable);
            headerSearchInput.addEventListener('keyup', filterTable);
        }

        statusFilter.addEventListener('change', filterTable);
        sourceFilter.addEventListener('change', filterTable);

        // Clear all filters function
        function clearAllFilters() {
            if (headerSearchInput) {
                headerSearchInput.value = '';
            }
            statusFilter.value = 'all';
            sourceFilter.value = 'all';
            filterTable();
        }

        // View lead details function
        function viewLeadDetails(leadId) {
            window.location.href = `/admin/lead/${leadId}`;
        }


     
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function () {
            updateCounts();

            // Add placeholder enhancement
            if (headerSearchInput) {
                headerSearchInput.placeholder = 'Search leads... (Ctrl+K)';
            }
        });

        // Real-time search feedback
        if (headerSearchInput) {
            headerSearchInput.addEventListener('input', function () {
                const searchWrapper = this.parentElement;
                if (this.value.trim() !== '') {
                    searchWrapper.style.borderColor = 'var(--primary-purple)';
                } else {
                    searchWrapper.style.borderColor = '';
                }
            });
        }

        // Pagination functionality
        const pageButtons = document.querySelectorAll('.page-btn');
        pageButtons.forEach(btn => {
            btn.addEventListener('click', function () {
                if (this.querySelector('i')) return; // Skip arrow buttons for now

                // Remove active class from all
                pageButtons.forEach(b => b.classList.remove('active'));
                // Add active to clicked
                this.classList.add('active');
            });
        });
    </script>

    <style>
        .badge-pending {
            background-color: #fef3c7;
            color: #92400e;
        }

        .badge-contacted {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .badge-converted {
            background-color: #d1fae5;
            color: #065f46;
        }

        .action-icon-btn.view {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .action-icon-btn.view:hover {
            background-color: #bfdbfe;
        }
    </style>

</body>

</html>