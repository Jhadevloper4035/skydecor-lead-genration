<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Lead Management Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="icon" type="image/png" href="/favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon/favicon.svg" />
    <link rel="shortcut icon" href="/favicon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Skydecor Lead" />
    <link rel="manifest" href="/favicon/site.webmanifest" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/css/admindashboard.css">
</head>

<body>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <%- include('../partials/side-menu') %>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Header -->
            <header class="top-header">
                <div class="header-left">
                    <button class="menu-toggle" id="menuToggle" aria-label="Toggle menu">
                        <i class="bi bi-list"></i>
                    </button>
                    <div class="search-box">
                        <i class="bi bi-search"></i>
                        <input type="text" placeholder="Search...">
                    </div>
                </div>

                <div class="header-right">
                    <button class="header-icon-btn" aria-label="Flag">
                        <i class="bi bi-flag"></i>
                    </button>
                    <button class="header-icon-btn" aria-label="Grid view">
                        <i class="bi bi-grid-3x3"></i>
                    </button>
                    <button class="header-icon-btn" aria-label="Notifications">
                        <i class="bi bi-bell"></i>
                        <span class="badge">3</span>
                    </button>
                    <button class="header-icon-btn" aria-label="Fullscreen">
                        <i class="bi bi-arrows-fullscreen"></i>
                    </button>
                    <button class="header-icon-btn" aria-label="Toggle dark mode">
                        <i class="bi bi-moon"></i>
                    </button>

                    <div class="user-profile">
                        <img src="https://ui-avatars.com/api/?name=<%= encodeURIComponent(user.name || 'User') %>&background=5b4a9f&color=fff"
                            alt="<%= user.name %> avatar" class="user-avatar">
                        <div class="user-info">
                            <h6 class="text-capitalize mb-0">
                                <%= user.name || 'User' %>
                            </h6>
                            <p class="text-uppercase mb-0">
                                <%= user.accessType || 'Guest' %>
                            </p>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div class="page-content">
                <!-- Page Header -->
                <div class="page-header mt-4">
                    <div>
                        <h1 class="page-title">Contact Enquiry</h1>
                        <div class="breadcrumb-custom">
                            <a href="/admin/dashboard" class="text-uppercase">Dashboards</a>
                            <i class="bi bi-chevron-right"></i>
                            <span class="text-uppercase">Website</span>
                            <i class="bi bi-chevron-right"></i>
                            <span class="text-uppercase">Conatact Enquiry</span>
                        </div>
                    </div>
                </div>

                <!-- Hero Card -->
                <div class="hero-card">
                    <div class="hero-content">
                        <div class="hero-text">
                            <h2>Discover, Collect, Track and Manage <span class="highlight">your Leads.</span></h2>
                            <p>The world's first and largest lead management platform.</p>
                            <div class="hero-buttons">
                                <a href="/admin/website/contact/enquiry/download" class="btn-hero primary">
                                    <i class="bi bi-download"></i> All Leads
                                </a>
                                <a href="/form/inquiry" class="btn-hero secondary">Add New Lead</a>
                            </div>
                        </div>
                        <div class="hero-illustration">
                            <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                <title>Lead management illustration</title>
                                <circle cx="100" cy="100" r="80" fill="#fbbf24" opacity="0.2" />
                                <circle cx="100" cy="80" r="30" fill="#764ba2" />
                                <rect x="75" y="110" width="50" height="60" rx="5" fill="#667eea" />
                                <circle cx="85" cy="90" r="5" fill="white" />
                                <circle cx="115" cy="90" r="5" fill="white" />
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon green">
                                <i class="bi bi-people"></i>
                            </div>
                            <button class="stat-menu" aria-label="Options">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                        </div>
                        <div class="stat-label">Total Leads</div>
                        <div class="stat-value" id="totalLeads">
                            <%= leads.length %>
                        </div>
                        <div class="stat-change up">
                            <i class="bi bi-arrow-up"></i>
                            <span>Active leads</span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon blue">
                                <i class="bi bi-hourglass-split"></i>
                            </div>
                            <button class="stat-menu" aria-label="Options">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                        </div>
                        <div class="stat-label">Pending Leads</div>
                        <div class="stat-value" id="pendingLeads">0</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon orange">
                                <i class="bi bi-globe"></i>
                            </div>
                            <button class="stat-menu" aria-label="Options">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                        </div>
                        <div class="stat-label">Website Source</div>
                        <div class="stat-value" id="websiteLeads">0</div>
                    </div>
                </div>

                <!-- Leads Table -->
                <div class="leads-table-wrapper">
                    <div class="table-header">
                        <div class="table-filters">
                            <select class="filter-select" id="statusFilter" aria-label="Filter by status">
                                <option value="all">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="contacted">Contacted</option>
                                <option value="converted">Converted</option>
                            </select>

                            <select class="filter-select" id="sourceFilter" aria-label="Filter by source">
                                <option value="all">All Sources</option>
                                <option value="website">Website</option>
                                <option value="phone">Phone</option>
                                <option value="email">Email</option>
                            </select>
                        </div>

                        <div class="table-actions">
                            <a href="/admin/website/contact/enquiry/download" class="btn-action primary">
                                <i class="bi bi-download"></i> Export
                            </a>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="leads-table">
                            <thead>
                                <tr>
                                    <th>Contact</th>
                                    <th>Phone</th>
                                    <th>Enquiry Type</th>
                                    <th>Comments</th>
                                    <th>Product Interest</th>
                                    <th>Consent</th>
                                    <th>Status</th>
                                    <th>Source</th>
                                    <th>IP Address</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="leadsTableBody">
                                <% if (leads && leads.length> 0) { %>
                                    <% leads.forEach(lead=> { %>
                                        <% const status=(lead.status || '' ).toLowerCase(); const
                                            statusClasses={ 'pending' : 'badge-pending' , 'contacted'
                                            : 'badge-contacted' , 'converted' : 'badge-converted' }; const
                                            statusClass=statusClasses[status] || 'badge-customer' ; %>
                                            <tr data-status="<%= status %>"
                                                data-source="<%= (lead.source || '').toLowerCase() %>">
                                                <td>
                                                    <div class="lead-user">
                                                        <div class="lead-avatar">
                                                            <%= (lead.name || 'U' ).charAt(0).toUpperCase() %>
                                                        </div>
                                                        <div>
                                                            <div class="lead-name">
                                                                <%= lead.name || 'N/A' %>
                                                            </div>
                                                            <div class="lead-email">
                                                                <%= lead.email || 'No email' %>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td><strong>
                                                        <%= lead.phone || 'N/A' %>
                                                    </strong></td>
                                                <td><strong>
                                                        <%= lead.enquiryType || 'N/A' %>
                                                    </strong></td>
                                                <td>
                                                    <div class="text-truncate" style="max-width: 200px;"
                                                        title="<%= (lead.comments || '').replace(/" /g, '&quot;' ) %>">
                                                        <%= lead.comments || 'N/A' %>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="product-list">
                                                        <span class="product-badge">
                                                            <%= lead.products || 'N/A' %>
                                                        </span>
                                                    </div>
                                                </td>
                                                <td>
                                                    <%= lead.consent || 'Not specified' %>
                                                </td>
                                                <td>
                                                    <span class="badge-type <%= statusClass %>">
                                                        <%= lead.status || 'N/A' %>
                                                    </span>
                                                </td>
                                                <td>
                                                    <%= lead.source || 'Not specified' %>
                                                </td>
                                                <td>
                                                    <small>
                                                        <%= lead.ipAddress || 'N/A' %>
                                                    </small>
                                                </td>
                                                <td>
                                                    <strong>
                                                        <%= new Date(lead.createdAt).toLocaleDateString() %>
                                                    </strong><br>
                                                    <small style="color: var(--text-muted);">
                                                        <%= new Date(lead.createdAt).toLocaleTimeString([],
                                                            {hour: '2-digit' , minute:'2-digit'}) %>
                                                    </small>
                                                    <% if (lead.timeElapsed) { %>
                                                        <br><small style="color: var(--primary-purple);">
                                                            <%= lead.timeElapsed %>
                                                        </small>
                                                        <% } %>
                                                </td>
                                                <td>
                                                    <div class="action-buttons">
                                                        <% if (lead.phone) { %>
                                                            <a href="tel:<%= lead.phone %>" class="action-icon-btn call"
                                                                title="Call" aria-label="Call <%= lead.name %>">
                                                                <i class="bi bi-telephone"></i>
                                                            </a>
                                                            <% } %>
                                                                <% if (lead.email) { %>
                                                                    <a href="mailto:<%= lead.email %>"
                                                                        class="action-icon-btn email" title="Email"
                                                                        aria-label="Email <%= lead.name %>">
                                                                        <i class="bi bi-envelope"></i>
                                                                    </a>
                                                                    <% } %>
                                                                        <button class="action-icon-btn view"
                                                                            title="View Details"
                                                                            aria-label="View details for <%= lead.name %>"
                                                                            data-lead-id="<%= lead._id %>">
                                                                            <i class="bi bi-eye"></i>
                                                                        </button>
                                                                        <button class="action-icon-btn more"
                                                                            title="More options"
                                                                            aria-label="More options">
                                                                            <i class="bi bi-three-dots"></i>
                                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            <% }) %>
                                                <% } else { %>
                                                    <tr>
                                                        <td colspan="11" class="text-center py-4">
                                                            <i class="bi bi-inbox"
                                                                style="font-size: 3rem; color: var(--text-muted);"></i>
                                                            <p class="mt-2 text-muted">No leads found</p>
                                                        </td>
                                                    </tr>
                                                    <% } %>
                            </tbody>
                        </table>
                    </div>

                    <div class="table-footer">
                        <div class="showing-info">
                            Showing <strong id="showingCount">0</strong> of <strong id="totalCount">0</strong> leads
                        </div>

                        <% const totalItems=leads.length; const perPage=10; const page=1; const
                            totalPages=Math.ceil(totalItems / perPage); %>

                            <div class="pagination">
                                <!-- Prev Button -->
                                <button class="page-btn <%= page === 1 ? 'disabled' : '' %>" aria-label="Previous page">
                                    <i class="bi bi-chevron-left"></i>
                                </button>

                                <!-- Page Numbers -->
                                <% for(let i=1; i <=totalPages; i++) { %>
                                    <button class="page-btn <%= page === i ? 'active' : '' %>"
                                        aria-label="Page <%= i %>">
                                        <%= i %>
                                    </button>
                                    <% } %>

                                        <!-- Next Button -->
                                        <button class="page-btn <%= page === totalPages ? 'disabled' : '' %>"
                                            aria-label="Next page">
                                            <i class="bi bi-chevron-right"></i>
                                        </button>
                            </div>
                    </div>
                </div>

            </div>
        </main>

        <!-- Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

        <script>
            // Mobile Menu Toggle
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            if (menuToggle && sidebar && sidebarOverlay) {
                menuToggle.addEventListener('click', function () {
                    sidebar.classList.toggle('active');
                    sidebarOverlay.classList.toggle('active');
                });

                sidebarOverlay.addEventListener('click', function () {
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                });
            }

            // Get all filter elements
            const headerSearchInput = document.querySelector('.search-box input');
            const statusFilter = document.getElementById('statusFilter');
            const sourceFilter = document.getElementById('sourceFilter');

            // Update counts function
            function updateCounts() {
                const allRows = document.querySelectorAll('#leadsTableBody tr');
                const visibleRows = Array.from(allRows).filter(row => row.style.display !== 'none');

                // Update showing count
                document.getElementById('showingCount').textContent = visibleRows.length;
                document.getElementById('totalCount').textContent = allRows.length;

                // Update stat cards
                const totalLeads = allRows.length;
                const pendingLeads = Array.from(allRows).filter(row =>
                    row.getAttribute('data-status') === 'pending'
                ).length;
                const websiteLeads = Array.from(allRows).filter(row =>
                    row.getAttribute('data-source') === 'website'
                ).length;

                document.getElementById('totalLeads').textContent = totalLeads;
                document.getElementById('pendingLeads').textContent = pendingLeads;
                document.getElementById('websiteLeads').textContent = websiteLeads;
            }

            // Debounce function for search
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            // Main filter function that combines all filters
            function filterTable() {
                const searchTerm = headerSearchInput ? headerSearchInput.value.toLowerCase().trim() : '';
                const statusValue = statusFilter.value;
                const sourceValue = sourceFilter.value;

                const rows = document.querySelectorAll('#leadsTableBody tr');

                rows.forEach(row => {
                    // Get row data
                    const status = row.getAttribute('data-status');
                    const source = row.getAttribute('data-source');
                    const rowText = row.textContent.toLowerCase();

                    // Check each filter condition
                    const matchesSearch = searchTerm === '' || rowText.includes(searchTerm);
                    const matchesStatus = statusValue === 'all' || status === statusValue;
                    const matchesSource = sourceValue === 'all' || source === sourceValue;

                    // Show row only if ALL conditions match
                    if (matchesSearch && matchesStatus && matchesSource) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });

                // Update counts after filtering
                updateCounts();
            }

            // Debounced search function
            const debouncedFilter = debounce(filterTable, 300);

            // Add event listeners to all filters
            if (headerSearchInput) {
                headerSearchInput.addEventListener('input', debouncedFilter);
            }

            if (statusFilter) {
                statusFilter.addEventListener('change', filterTable);
            }

            if (sourceFilter) {
                sourceFilter.addEventListener('change', filterTable);
            }

            // View lead details using data attributes
            document.addEventListener('click', function (e) {
                if (e.target.closest('.view')) {
                    const btn = e.target.closest('.view');
                    const leadId = btn.getAttribute('data-lead-id');
                    if (leadId) {
                        window.location.href = `/admin/lead/${leadId}`;
                    }
                }
            });

            // Keyboard shortcut for search (Ctrl+K)
            document.addEventListener('keydown', function (e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    if (headerSearchInput) {
                        headerSearchInput.focus();
                    }
                }
            });

            // Initialize on page load
            document.addEventListener('DOMContentLoaded', function () {
                updateCounts();

                // Add placeholder enhancement
                if (headerSearchInput) {
                    headerSearchInput.placeholder = 'Search leads... (Ctrl+K)';
                }

                // Real-time search feedback
                if (headerSearchInput) {
                    headerSearchInput.addEventListener('input', function () {
                        const searchWrapper = this.parentElement;
                        if (this.value.trim() !== '') {
                            searchWrapper.style.borderColor = 'var(--primary-purple)';
                        } else {
                            searchWrapper.style.borderColor = '';
                        }
                    });
                }
            });

            // Pagination functionality
            const pageButtons = document.querySelectorAll('.page-btn');
            pageButtons.forEach(btn => {
                btn.addEventListener('click', function () {
                    if (this.querySelector('i')) return; // Skip arrow buttons for now
                    if (this.classList.contains('disabled')) return;

                    // Remove active class from all
                    pageButtons.forEach(b => b.classList.remove('active'));
                    // Add active to clicked
                    this.classList.add('active');
                });
            });
        </script>

</body>

</html>